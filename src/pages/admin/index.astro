---
import AdminLayout from '~/layouts/AdminLayout.astro';

interface DashboardStats {
  totalImageCount: number;
  activeApiKeyCount: number;
}

// Expected structure for API key metadata when listing keys from dashboard-stats.ts
interface ApiKeyMetadata {
  status?: 'active' | 'revoked';
}

async function getDashboardStats(locals: App.Locals): Promise<DashboardStats> {
  const user = locals.user;
  if (!user) {
    console.warn('Dashboard: User not authenticated.');
    return { totalImageCount: 0, activeApiKeyCount: 0 }; // Default or error state
  }

  const { IMGBED_KV } = locals.runtime.env;
  if (!IMGBED_KV) {
    console.error('Dashboard: IMGBED_KV is not available.');
    return { totalImageCount: 0, activeApiKeyCount: 0 }; // Default or error state
  }

  try {
    const imageListResult = await IMGBED_KV.list({ prefix: 'image:' });
    const totalImageCount = imageListResult.keys.length;

    const apiKeyListResult = await IMGBED_KV.list({ prefix: 'apikey_record:' });
    let activeApiKeyCount = 0;
    
    for (const key of apiKeyListResult.keys) {
      const metadata = key.metadata as ApiKeyMetadata | undefined;
      if (metadata && metadata.status === 'active') {
        activeApiKeyCount++;
      }
    }
    
    return {
      totalImageCount,
      activeApiKeyCount,
    };

  } catch (e: any) {
    console.error('Dashboard (SSR): Error fetching dashboard stats:', e.message);
    return { totalImageCount: 0, activeApiKeyCount: 0 }; // Return default/error state
  }
}

const stats = await getDashboardStats(Astro.locals);
---

<AdminLayout title="仪表盘 - 后台管理">
  <header class="mb-8">
    <h1 class="text-3xl font-bold">仪表盘</h1>
  </header>
  
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="border border-border p-6 bg-background">
      <h2 class="text-xl font-semibold mb-2">总图片数</h2>
      <p id="stats-total-images" class="text-3xl font-bold">{stats.totalImageCount.toLocaleString()}</p>
      <p class="text-sm text-gray-500 mt-1">当前存储中的图片总数</p>
    </div>
    
    <div class="border border-border p-6 bg-background">
      <h2 class="text-xl font-semibold mb-2">活跃 API Keys</h2>
      <p id="stats-active-apikeys" class="text-3xl font-bold">{stats.activeApiKeyCount.toLocaleString()}</p>
      <p class="text-sm text-gray-500 mt-1">当前有效的 API Key 数量</p>
    </div>
  </div>

  <div class="mt-10 border border-border p-6 bg-background">
    <h2 class="text-xl font-semibold mb-4">快速操作</h2>
    <div class="flex flex-wrap gap-4">
      <a href="/admin/images" class="bg-background text-text border py-2 px-4 hover:text-background hover:bg-text hover:opacity-90 transition-opacity">
        管理图片
      </a>
      <a href="/admin/api-keys" class="bg-background text-text border py-2 px-4 hover:text-background hover:bg-text hover:opacity-90 transition-opacity">
        管理 API Keys
      </a>
      <a href="/admin/settings" class="bg-background text-text border py-2 px-4 hover:text-background hover:bg-text hover:opacity-90 transition-opacity">
        系统设置
      </a>
      <a href="/" class="bg-background text-text border py-2 px-4 hover:text-background hover:bg-text hover:opacity-90 transition-opacity">
        访问主站
      </a>
    </div>
  </div>
</AdminLayout>

<!-- Client-side script for fetching stats is no longer needed -->
